<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Hubz PDV Bira</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .scrollbar-thin::-webkit-scrollbar {
      height: 6px;
      width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: #0a2a5a;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #2563eb;
      border-radius: 10px;
    }
    .timer {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      font-size: 0.6rem;
      color: #f97316;
      min-width: 40px;
      text-align: right;
    }
    button.remove-item {
      background: transparent;
      border: none;
      color: #f97316;
      cursor: pointer;
      font-size: 0.85rem;
      padding: 0;
      transition: color 0.2s;
    }
    button.remove-item:hover {
      color: #ea580c;
    }
    .active-category {
      background-color: #e0e7ff !important;
      border-color: #2563eb !important;
      color: #0f3a7d !important;
    }
    #btnFullscreenToggle {
      background-color: #2563eb;
      color: white;
      padding: 0.15rem 0.5rem;
      border-radius: 0.375rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 0.75rem;
    }
    #btnFullscreenToggle:hover {
      background-color: #1e40af;
    }
    #produtosGrid.scrollable {
      max-height: 270px;
      overflow-y: auto;
    }
    #relatorioEstoque {
      max-height: 260px;
      overflow-y: auto;
    }
    #mesaStatusBadge {
      position: relative;
      font-size: 0.75rem;
    }
    #mesaStatusBadge::after {
      content: "Você tem uma comanda em aberto no balcão ou mesa.";
      position: absolute;
      bottom: 125%;
      right: 50%;
      transform: translateX(50%);
      background-color: #f97316;
      color: white;
      padding: 4px 7px;
      border-radius: 6px;
      white-space: nowrap;
      font-size: 0.6rem;
      font-weight: 600;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }
    #mesaStatusBadge::before {
      content: "";
      position: absolute;
      bottom: 115%;
      right: 50%;
      transform: translateX(50%);
      border-width: 6px;
      border-style: solid;
      border-color: #f97316 transparent transparent transparent;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }
    #mesaStatusBadge:hover::after,
    #mesaStatusBadge:hover::before {
      opacity: 1;
      pointer-events: auto;
    }
    #contadorMesasAbertas {
      background-color: #f97316;
      color: white;
      font-weight: 700;
      font-size: 0.6rem;
      padding: 0 4px;
      border-radius: 9999px;
      min-width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 3px;
      user-select: none;
    }
    #modalDelivery,
    #modalCreateOrder,
    #modalDiscount,
    #modalWhatsAppWeb {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }
    #modalDelivery.active,
    #modalCreateOrder.active,
    #modalDiscount.active,
    #modalWhatsAppWeb.active {
      display: flex;
    }
    #modalWhatsAppWeb {
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 100;
    }
    #modalWhatsAppWebContent {
      position: relative;
      width: 90vw;
      height: 90vh;
      background: white;
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
    }
    #modalWhatsAppWeb iframe {
      flex: 1;
      border: none;
      width: 100%;
      height: 100%;
    }
    #btnCloseWhatsAppWeb {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: #f97316;
      color: white;
      border: none;
      border-radius: 0.375rem;
      padding: 0.2rem 0.4rem;
      font-weight: 600;
      cursor: pointer;
      z-index: 10;
      transition: background-color 0.2s;
      font-size: 0.75rem;
    }
    #btnCloseWhatsAppWeb:hover {
      background-color: #ea580c;
    }
    @media (max-width: 767px) {
      nav > button > span {
        display: none;
      }
      nav > button {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      #produtosGrid {
        grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
        max-height: 180px !important;
        overflow-y: auto !important;
      }
    }
    .editable-mesa {
      border: none;
      background: transparent;
      font-weight: 700;
      font-size: 0.9rem;
      color: #0f3a7d;
      width: auto;
      max-width: 100%;
      padding: 0;
      margin: 0;
      outline: none;
      cursor: text;
      user-select: text;
    }
    .editable-cliente {
      border: none;
      background: transparent;
      font-weight: 600;
      font-size: 0.85rem;
      color: #0f3a7d;
      width: 100%;
      max-width: 100%;
      padding: 0;
      margin: 0 0 0.3rem 0;
      outline: none;
      cursor: text;
      user-select: text;
      border-bottom: 1px dashed #2563eb;
    }
  </style>
</head>
<body class="bg-[#0f3a7d] font-sans select-none">
  <div
    class="max-w-[1200px] mx-auto mt-3 rounded-lg shadow-lg bg-[#0f3a7d] border border-[#0a2a5a]"
    id="appContainer"
  >
    <header
      class="flex flex-col md:flex-row items-center justify-between bg-[#0a2a5a] rounded-t-lg px-4 py-1.5 text-white select-none space-y-1 md:space-y-0"
    >
      <nav
        class="flex flex-wrap justify-center md:justify-end items-center gap-1.5 w-full md:w-auto text-xs font-semibold"
      >
        <button
          class="flex items-center space-x-1 bg-[#f97316] px-2 py-1 rounded shadow-md hover:bg-[#ea580c] transition"
          id="btnVenda"
          title="Aba PDV"
        >
          <i class="fas fa-cash-register"></i>
          <span>PDV</span>
        </button>
        <button
          class="flex items-center space-x-1 hover:text-[#f97316] transition cursor-pointer px-2 py-1 rounded hover:bg-[#0f3a7d] relative"
          id="btnPedidos"
          title="Aba Pedidos"
        >
          <i class="fas fa-clipboard-list"></i>
          <span>Pedidos</span>
          <span
            class="absolute -top-1 -right-2 bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-[9px] font-bold shadow-md select-none hidden"
            id="badgePedidos"
            >0</span
          >
        </button>
        <button
          class="flex items-center space-x-1 hover:text-[#f97316] transition cursor-pointer px-2 py-1 rounded hover:bg-[#0f3a7d] relative"
          id="btnDelivery"
          title="Aba Entregas"
        >
          <i class="fas fa-motorcycle"></i>
          <span>Entregas</span>
          <span
            class="absolute -top-1 -right-2 bg-green-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-[9px] font-bold shadow-md select-none hidden"
            id="badgeDelivery"
            >0</span
          >
        </button>
        <button
          class="flex items-center space-x-1 hover:text-[#f97316] transition cursor-pointer px-2 py-1 rounded hover:bg-[#0f3a7d]"
          id="btnFinanceiro"
          title="Abrir aba Financeiro"
          type="button"
        >
          <i class="fas fa-dollar-sign"></i>
          <span>Financeiro</span>
        </button>
        <button
          class="flex items-center space-x-1 hover:text-[#f97316] transition cursor-pointer text-[#f97316] px-2 py-1 rounded"
          id="btnEstoque"
          title="Abrir aba Estoque"
          type="button"
        >
          <i class="fas fa-boxes"></i>
          <span>Estoque</span>
        </button>
        <button
          class="flex items-center space-x-1 hover:text-[#f97316] transition cursor-pointer px-2 py-1 rounded hover:bg-[#0f3a7d]"
          id="btnCreateOrder"
          title="Criar Comanda a partir de texto"
          type="button"
        >
          <i class="fas fa-file-alt"></i>
        </button>
        <button
          aria-label="Alternar tela cheia"
          class="flex items-center space-x-1"
          id="btnFullscreenToggle"
          title="Alternar tela cheia"
          type="button"
        >
          <i class="fas fa-expand"></i>
          <span>Tela Cheia</span>
        </button>
        <a
          href="https://wa.me/67992526860"
          target="_blank"
          rel="noopener noreferrer"
          aria-label="Abrir WhatsApp Web"
          class="flex items-center px-2 py-1 rounded hover:bg-[#0f3a7d] transition text-white hover:text-[#25D366]"
          id="btnWhatsAppWeb"
          title="Abrir WhatsApp Web"
          style=""
          ><i class="fab fa-whatsapp text-lg"></i
        ></a>
      </nav>
    </header>
    <div
      class="flex flex-col md:flex-row border-t border-[#0a2a5a] relative min-h-[520px]"
      id="appContainerMain"
    >
      <div
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        id="modalMesas"
        role="dialog"
        aria-modal="true"
        aria-labelledby="modalTitle"
      >
        <div
          class="bg-white rounded-lg max-w-md w-full p-4 max-h-[70vh] overflow-auto"
        >
          <h2
            class="text-base font-bold mb-2 text-[#0f3a7d] select-text"
            id="modalTitle"
          >
            Selecione a Mesa ou Balcão
          </h2>
          <div class="grid grid-cols-6 gap-1.5" id="mesasGrid"></div>
          <div class="mt-4 flex justify-end space-x-2">
            <button
              class="px-3 py-1 bg-[#0f3a7d] text-white rounded hover:bg-[#0a2a5a] transition"
              id="btnFecharMesas"
              type="button"
            >
              Fechar
            </button>
          </div>
        </div>
      </div>
      <div
        aria-labelledby="modalDeliveryTitle"
        aria-modal="true"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60"
        id="modalDelivery"
        role="dialog"
      >
        <div
          class="bg-white rounded-lg max-w-lg w-full p-4 max-h-[70vh] overflow-auto"
        >
          <h2
            class="text-base font-bold mb-2 text-[#0f3a7d] select-text"
            id="modalDeliveryTitle"
          >
            Informações para Entregas
          </h2>
          <form id="formDelivery" class="space-y-2">
            <div>
              <label
                for="clienteNome"
                class="block text-sm font-semibold text-[#0f3a7d] mb-1"
                >Nome do Cliente</label
              >
              <input
                type="text"
                id="clienteNome"
                name="clienteNome"
                required
                class="w-full border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-[#2563eb]"
              />
            </div>
            <div>
              <label
                for="enderecoColeta"
                class="block text-sm font-semibold text-[#0f3a7d] mb-1"
                >Endereço de Coleta</label
              >
              <input
                type="text"
                id="enderecoColeta"
                name="enderecoColeta"
                required
                class="w-full border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-[#2563eb]"
                value="Rua Báltico 79 Jardim Presidente"
              />
            </div>
            <div>
              <label
                for="enderecoEntrega"
                class="block text-sm font-semibold text-[#0f3a7d] mb-1"
                >Endereço de Entrega</label
              >
              <input
                type="text"
                id="enderecoEntrega"
                name="enderecoEntrega"
                required
                class="w-full border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-[#2563eb]"
              />
            </div>
            <div id="deliveryRates" class="text-xs text-gray-700 space-y-1">
              <p>Consultando taxas de entrega...</p>
            </div>
            <div class="flex justify-end space-x-2 mt-2">
              <button
                type="button"
                id="btnCancelDelivery"
                class="px-3 py-1 bg-gray-400 rounded hover:bg-gray-500 text-white font-semibold transition"
              >
                Cancelar
              </button>
              <button
                type="submit"
                id="btnConfirmDelivery"
                class="px-3 py-1 bg-green-700 rounded hover:bg-green-800 text-white font-semibold transition"
              >
                Confirmar
              </button>
            </div>
          </form>
        </div>
      </div>
      <div
        aria-labelledby="modalCreateOrderTitle"
        aria-modal="true"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-70"
        id="modalCreateOrder"
        role="dialog"
      >
        <div
          class="bg-white rounded-lg max-w-lg w-full p-4 max-h-[70vh] overflow-auto"
        >
          <h2
            class="text-base font-bold mb-2 text-[#0f3a7d] select-text"
            id="modalCreateOrderTitle"
          >
            Criar Comanda a partir de Texto
          </h2>
          <textarea
            id="inputCreateOrder"
            rows="10"
            class="w-full border border-gray-300 rounded p-2 text-xs font-mono resize-y focus:outline-none focus:ring-2 focus:ring-[#2563eb]"
            placeholder="Cole o texto do pedido aqui..."
          ></textarea>
          <div class="flex justify-end space-x-2 mt-2">
            <button
              type="button"
              id="btnCancelCreateOrder"
              class="px-3 py-1 bg-gray-400 rounded hover:bg-gray-500 text-white font-semibold transition"
            >
              Cancelar
            </button>
            <button
              type="button"
              id="btnConfirmCreateOrder"
              class="px-3 py-1 bg-green-700 rounded hover:bg-green-800 text-white font-semibold transition"
            >
              Criar Comanda
            </button>
          </div>
        </div>
      </div>
      <section class="flex-1 p-2 space-y-1" id="vendaSection">
        <div class="flex space-x-1 mb-1">
          <button
            class="flex-1 bg-white text-[#0f3a7d] font-bold text-[10px] py-1 rounded border border-[#0a2a5a] hover:bg-[#e0e7ff] transition flex items-center justify-center space-x-1 active-category"
            id="btnCatTodos"
            data-categoria="todos"
            title="Mostrar todos os produtos"
          >
            <i class="fas fa-th-large text-xs"></i>
            <span>Todos</span>
          </button>
          <button
            class="flex-1 bg-white text-[#0f3a7d] font-bold text-[10px] py-1 rounded border border-[#0a2a5a] hover:bg-[#e0e7ff] transition flex items-center justify-center space-x-1"
            id="btnCatMarmitas"
            data-categoria="marmitas"
            title="Mostrar marmitas"
          >
            <i class="fas fa-wine-glass-alt text-xs"></i>
            <span>MARMITAS</span>
          </button>
          <button
            class="flex-1 bg-white text-[#0f3a7d] font-bold text-[10px] py-1 rounded border border-[#0a2a5a] hover:bg-[#e0e7ff] transition flex items-center justify-center space-x-1"
            id="btnCatBebidas"
            data-categoria="bebidas"
            title="Mostrar bebidas"
          >
            <i class="fas fa-beer text-xs"></i>
            <span>BEBIDAS</span>
          </button>
          <button
            class="flex-1 bg-white text-[#0f3a7d] font-bold text-[10px] py-1 rounded border border-[#0a2a5a] hover:bg-[#e0e7ff] transition flex items-center justify-center space-x-1"
            id="btnCatPorcoes"
            data-categoria="porcoes"
            title="Mostrar porções"
          >
            <i class="fas fa-shopping-basket text-xs"></i>
            <span>PORÇÕES</span>
          </button>
        </div>
        <div
          id="produtosGrid"
          class="scrollbar-thin scrollable grid grid-cols-3 sm:grid-cols-3 md:grid-cols-5 gap-1"
          tabindex="0"
          aria-label="Lista de produtos para venda"
        ></div>
      </section>
      <section
        class="hidden flex-1 p-2 space-y-2 bg-white rounded border border-[#0a2a5a] overflow-auto max-h-[calc(100vh-100px)]"
        id="comandaCardsContainer"
        aria-live="polite"
        aria-atomic="true"
      >
        <h2 class="text-[#0f3a7d] font-bold text-base mb-2 select-text">
          Comandas em Aberto
        </h2>
        <div
          class="flex items-center space-x-2 w-full md:w-auto relative"
          style=""
        >
          <span
            class="absolute -top-2 -right-5 bg-red-600 text-white rounded-full w-4.5 h-4.5 flex items-center justify-center text-xs font-bold shadow-md hidden"
            id="mesaStatusBadge"
            style=""
            title="Mesa com comanda em aberto"
            >!</span
          >
          <button
            class="bg-[#f97316] text-white rounded-full w-5.5 h-5.5 flex items-center justify-center text-xs font-bold shadow-md hover:bg-[#ea580c] transition"
            disabled
            id="btnAbrirComandaMesa"
            title="Abrir comanda em aberto da mesa selecionada"
            type="button"
          >
            <i class="fas fa-folder-open text-sm"></i>
          </button>
        </div>
      </section>
      <section
        class="hidden flex-1 p-2 space-y-1 bg-white rounded border border-[#0a2a5a] overflow-auto max-h-[calc(100vh-100px)]"
        id="estoqueSection"
        aria-label="Gestão de estoque"
      >
        <h2 class="text-[#0f3a7d] font-bold text-base mb-2 select-text">
          Gestão de Estoque
        </h2>
        <div
          class="flex flex-wrap gap-1 mb-2"
          role="tablist"
          aria-label="Categorias de estoque"
        >
          <button
            class="px-3 py-1 bg-[#0a2a5a] text-white rounded hover:bg-[#0f3a7d] transition font-semibold active-category text-xs"
            id="btnCatTodosEstoque"
            data-categoria="todos"
            role="tab"
            aria-selected="true"
            tabindex="0"
            >Todos</button
          >
          <button
            class="px-3 py-1 bg-[#0a2a5a] text-white rounded hover:bg-[#0f3a7d] transition font-semibold text-xs"
            id="btnCatMarmitasEstoque"
            data-categoria="marmitas"
            role="tab"
            aria-selected="false"
            tabindex="-1"
            >Marmitas</button
          >
          <button
            class="px-3 py-1 bg-[#0a2a5a] text-white rounded hover:bg-[#0f3a7d] transition font-semibold text-xs"
            id="btnCatBebidasEstoque"
            data-categoria="bebidas"
            role="tab"
            aria-selected="false"
            tabindex="-1"
            >Bebidas</button
          >
          <button
            class="px-3 py-1 bg-[#0a2a5a] text-white rounded hover:bg-[#0f3a7d] transition font-semibold text-xs"
            id="btnCatPorcoesEstoque"
            data-categoria="porcoes"
            role="tab"
            aria-selected="false"
            tabindex="-1"
            >Porções</button
          >
        </div>
        <div
          class="space-y-1 max-h-[52vh] overflow-auto scrollbar-thin"
          id="estoqueLista"
          tabindex="0"
          aria-label="Lista de produtos em estoque"
        ></div>
      </section>
      <section
        class="hidden flex-1 p-2 space-y-2 bg-white rounded border border-[#0a2a5a] overflow-auto max-h-[calc(100vh-100px)]"
        id="financeiroSection"
        aria-label="Painel financeiro"
      >
        <h2 class="text-[#0f3a7d] font-bold text-base mb-4 select-text">
          Painel Financeiro
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
          <div
            class="bg-[#0f3a7d] text-white rounded p-3 shadow flex flex-col items-center justify-center"
            role="region"
            aria-label="Vendas realizadas"
          >
            <div class="text-3xl font-bold" id="totalVendasCount">0</div>
            <div class="text-xs mt-1">Vendas Realizadas</div>
          </div>
          <div
            class="bg-[#0f3a7d] text-white rounded p-3 shadow flex flex-col items-center justify-center"
            role="region"
            aria-label="Mesas atendidas"
          >
            <div class="text-3xl font-bold" id="mesasAtendidasCount">0</div>
            <div class="text-xs mt-1">Mesas Atendidas</div>
          </div>
          <div
            class="bg-[#0f3a7d] text-white rounded p-3 shadow flex flex-col items-center justify-center"
            role="region"
            aria-label="Valor total das vendas"
          >
            <div class="text-3xl font-bold" id="valorTotalVendas">R$ 0,00</div>
            <div class="text-xs mt-1">Valor Total das Vendas</div>
          </div>
        </div>
        <div class="mb-4" role="region" aria-label="Gráfico de vendas por mesa">
          <canvas id="graficoVendasPorMesa" class="w-full max-w-full h-44"></canvas>
        </div>
        <div class="mb-4" role="region" aria-label="Gráfico de vendas por categoria">
          <canvas
            id="graficoVendasPorCategoria"
            class="w-full max-w-full h-44"
          ></canvas>
        </div>
      </section>
      <section
        class="hidden flex-1 p-2 space-y-2 bg-white rounded border border-[#0a2a5a] overflow-auto max-h-[calc(100vh-100px)]"
        id="deliverySection"
        aria-label="Pedidos para entregas"
      >
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-[#0f3a7d] font-bold text-base select-text">
            Entregas
          </h2>
          <span
            id="contadorDelivery"
            class="bg-green-600 text-white rounded-full px-2 py-0.5 text-xs font-semibold select-none hidden"
            aria-live="polite"
            aria-atomic="true"
          ></span>
        </div>
        <div
          id="deliveryPedidosContainer"
          class="space-y-2 overflow-auto max-h-[calc(100vh-140px)]"
          tabindex="0"
          aria-label="Lista de entregas"
        ></div>
      </section>
      <aside
        class="w-full md:w-[360px] bg-[#0a2a5a] p-2 flex flex-col space-y-2 border-l border-[#0a2a5a]"
        aria-label="Resumo da comanda e controles"
      >
        <form class="flex space-x-2 relative items-center" aria-label="Selecionar mesa">
          <button
            aria-label="Abrir seleção de mesas ou balcão"
            class="bg-white border border-[#0a2a5a] rounded px-2 flex items-center justify-center hover:bg-gray-100 transition h-[30px]"
            id="btnAbrirMesas"
            type="button"
          >
            <i class="fas fa-utensils text-[#0f3a7d] text-sm"></i>
            <span
              id="contadorMesasAbertas"
              class="ml-1 hidden text-[#0f3a7d] font-semibold text-xs select-none"
              aria-live="polite"
              aria-atomic="true"
              >0</span
            >
          </button>
          <div class="flex-1 flex items-center">
            <label
              class="block text-white text-xs font-semibold mb-1 mr-1"
              for="codigo"
              style=""
              >Selecionado</label
            >
            <input
              class="flex-1 rounded border border-[#0a2a5a] px-2 py-1 text-xs font-semibold text-[#0f3a7d]"
              id="codigo"
              placeholder="Selecione uma mesa"
              readonly
              type="text"
              aria-readonly="true"
              aria-label="Mesa selecionada"
            />
          </div>
        </form>
        <div
          class="flex-1 bg-white rounded border border-[#0a2a5a] overflow-auto scrollbar-thin max-h-[280px]"
          role="region"
          aria-label="Itens da comanda"
        >
          <table
            class="w-full text-xs font-semibold text-[#0f3a7d] border-collapse"
            role="table"
          >
            <thead>
              <tr class="bg-[#f97316] text-white" role="row">
                <th class="text-left px-2 py-1" role="columnheader">Imagem</th>
                <th class="text-left px-2 py-1" role="columnheader">Produto</th>
                <th class="w-9 text-center" role="columnheader">Qtde</th>
                <th class="w-16 text-right pr-2" role="columnheader">Unitário</th>
                <th class="w-16 text-right pr-2" role="columnheader">Total</th>
                <th class="w-7 pr-2 text-center" role="columnheader">Remover</th>
              </tr>
            </thead>
            <tbody id="comandaBody" role="rowgroup">
              <tr role="row">
                <td
                  class="text-center text-gray-400 py-2 select-text"
                  colspan="6"
                  role="cell"
                >
                  Nenhum item adicionado.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div
          class="text-white font-bold text-sm"
          role="region"
          aria-label="Valor total da comanda"
        >
          <div class="mb-1">Valor Total</div>
          <div
            class="bg-[#0f3a7d] rounded px-3 py-1.5 text-right text-2xl border border-[#0a2a5a] select-text"
            id="valorTotal"
            aria-live="polite"
            aria-atomic="true"
          >
            R$ 0,00
          </div>
        </div>
        <div>
          <label for="clienteNomeComanda" class="block text-white font-semibold mb-1"
            >Nome do Cliente</label
          >
          <input
            type="text"
            id="clienteNomeComanda"
            class="editable-cliente"
            placeholder="Digite o nome do cliente"
            aria-label="Nome do cliente da comanda"
          />
        </div>
        <div class="flex space-x-2">
          <button
            class="flex-1 bg-[#0f3a7d] border border-[#0a2a5a] rounded py-2 text-white font-semibold flex items-center justify-center space-x-1 hover:bg-[#0a2a5a] transition"
            disabled
            id="btnCancelar"
            type="button"
            aria-disabled="true"
          >
            <i class="fas fa-times-circle text-base"></i>
            <span>Cancelar</span>
          </button>
          <button
            class="flex-1 bg-green-700 border border-green-800 rounded py-2 text-white font-semibold flex items-center justify-center space-x-1 hover:bg-green-800 transition"
            id="btnFinalizar"
            type="button"
          >
            <span>Finalizar</span>
          </button>
        </div>
        <button
          id="btnImprimirComanda"
          class="mt-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded transition flex items-center justify-center space-x-1"
          type="button"
          aria-label="Imprimir comanda"
        >
          <i class="fas fa-print"></i>
        </button>
      </aside>
    </div>
    <footer
      class="flex justify-between items-center bg-[#0a2a5a] rounded-b-lg px-4 py-1 text-white text-xs font-semibold select-none"
    >
      <div>Versão 1.0.0</div>
      <div>Super Hubz PDV 0.1.1</div>
      <div>Dev: Neves</div>
    </footer>
  </div>
  <script>
    (() => {
      const btnAbrirMesas = document.getElementById("btnAbrirMesas");
      const btnEstoque = document.getElementById("btnEstoque");
      const btnVenda = document.getElementById("btnVenda");
      const btnFinanceiro = document.getElementById("btnFinanceiro");
      const btnFullscreenToggle = document.getElementById("btnFullscreenToggle");
      const modalMesas = document.getElementById("modalMesas");
      const btnFecharMesas = document.getElementById("btnFecharMesas");
      const mesasGrid = modalMesas.querySelector("div.grid");
      const codigoInput = document.getElementById("codigo");
      const comandaBody = document.getElementById("comandaBody");
      const valorTotalEl = document.getElementById("valorTotal");
      const btnCancelar = document.getElementById("btnCancelar");
      const btnFinalizar = document.getElementById("btnFinalizar");
      const vendaSection = document.getElementById("vendaSection");
      const estoqueSection = document.getElementById("estoqueSection");
      const financeiroSection = document.getElementById("financeiroSection");
      const estoqueLista = document.getElementById("estoqueLista");
      const comandaCardsContainer = document.getElementById("comandaCardsContainer");
      const produtosGrid = document.getElementById("produtosGrid");
      const btnImprimirComanda = document.querySelectorAll("#btnImprimirComanda");
      const btnAbrirComandaMesa = document.getElementById("btnAbrirComandaMesa");
      const mesaStatusBadge = document.getElementById("mesaStatusBadge");
      const appContainer = document.getElementById("appContainer");
      const btnPedidos = document.getElementById("btnPedidos");
      const badgePedidos = document.getElementById("badgePedidos");
      const contadorMesasAbertas = document.getElementById("contadorMesasAbertas");
      const btnDelivery = document.getElementById("btnDelivery");
      const deliverySection = document.getElementById("deliverySection");
      const deliveryPedidosContainer = document.getElementById("deliveryPedidosContainer");
      const modalDelivery = document.getElementById("modalDelivery");
      const formDelivery = document.getElementById("formDelivery");
      const btnCancelDelivery = document.getElementById("btnCancelDelivery");
      const deliveryRatesDiv = document.getElementById("deliveryRates");
      const badgeDelivery = document.getElementById("badgeDelivery");
      const contadorDelivery = document.getElementById("contadorDelivery");
      const btnCreateOrder = document.getElementById("btnCreateOrder");
      const modalCreateOrder = document.getElementById("modalCreateOrder");
      const inputCreateOrder = document.getElementById("inputCreateOrder");
      const btnCancelCreateOrder = document.getElementById("btnCancelCreateOrder");
      const btnConfirmCreateOrder = document.getElementById("btnConfirmCreateOrder");
      const clienteNomeComandaInput = document.getElementById("clienteNomeComanda");

      let mesaSelecionada = null;
      let comanda = {};
      const comandasFinalizadas = [];
      const comandasEmAberto = {};
      let vendasFinalizadas = [];
      const timers = {};
      let pedidosAbertos = [];
      let pedidosDelivery = [];

      let taxaEntregaValor = 1.0;
      const clientesComanda = {};

      const estoqueDados = {
        marmitas: [
          {
            id: 1,
            nome: "Marmita P",
            preco: 12.0,
            estoque: 50,
            img: "https://placehold.co/80x80/png?text=Marmita+P",
          },
          {
            id: 2,
            nome: "Marmita M",
            preco: 15.0,
            estoque: 40,
            img: "https://placehold.co/80x80/png?text=Marmita+M",
          },
          {
            id: 3,
            nome: "Marmita G",
            preco: 20.0,
            estoque: 30,
            img: "https://placehold.co/80x80/png?text=Marmita+G",
          },
        ],
        bebidas: [
          {
            id: 4,
            nome: "Coca-Cola Mini 269ml",
            preco: 5.0,
            estoque: 60,
            img: "https://placehold.co/80x80/png?text=Coca-Cola+Mini",
          },
          {
            id: 5,
            nome: "Guaraná 310ml",
            preco: 4.0,
            estoque: 55,
            img: "https://placehold.co/80x80/png?text=Guaraná+310ml",
          },
          {
            id: 6,
            nome: "Refriko Pet 500ml",
            preco: 5.0,
            estoque: 50,
            img: "https://placehold.co/80x80/png?text=Refriko+500ml",
          },
          {
            id: 7,
            nome: "Coca-Cola Vidro 1L",
            preco: 8.0,
            estoque: 45,
            img: "https://placehold.co/80x80/png?text=Coca-Cola+1L",
          },
          {
            id: 8,
            nome: "Coca-Cola Pet 2L",
            preco: 15.0,
            estoque: 40,
            img: "https://placehold.co/80x80/png?text=Coca-Cola+2L",
          },
          {
            id: 9,
            nome: "Tubaína Pet 2L",
            preco: 8.0,
            estoque: 35,
            img: "https://placehold.co/80x80/png?text=Tubaína+2L",
          },
        ],
        porcoes: [
          {
            id: 10,
            nome: "Carne Assada 100g",
            preco: 9.0,
            estoque: 60,
            img: "https://placehold.co/80x80/png?text=Carne+Assada",
          },
          {
            id: 11,
            nome: "Marmita de Arroz",
            preco: 7.0,
            estoque: 55,
            img: "https://placehold.co/80x80/png?text=Marmita+Arroz",
          },
          {
            id: 12,
            nome: "Marmita de Feijão",
            preco: 6.0,
            estoque: 50,
            img: "https://placehold.co/80x80/png?text=Marmita+Feijão",
          },
          {
            id: 13,
            nome: "Marmita de Macarrão",
            preco: 6.0,
            estoque: 45,
            img: "https://placehold.co/80x80/png?text=Marmita+Macarrão",
          },
        ],
        todos: [],
      };

      function atualizarCategoriaTodos() {
        const taxaEntregaItem = {
          id: 9999,
          nome: "Taxa de Entrega",
          preco: taxaEntregaValor,
          estoque: 9999,
          img: "https://placehold.co/80x80/png?text=Entrega",
          isTaxaEntrega: true,
        };
        estoqueDados.todos = [
          taxaEntregaItem,
          ...estoqueDados.marmitas,
          ...estoqueDados.bebidas,
          ...estoqueDados.porcoes,
        ];
      }
      atualizarCategoriaTodos();

      function carregarVendasLocalStorage() {
        const data = localStorage.getItem("vendasFinalizadas");
        if (data) {
          try {
            vendasFinalizadas = JSON.parse(data);
          } catch {
            vendasFinalizadas = [];
          }
        }
      }

      function salvarVendasLocalStorage() {
        localStorage.setItem("vendasFinalizadas", JSON.stringify(vendasFinalizadas));
      }

      function calcularTotal(itens) {
        return itens.reduce((acc, item) => acc + item.price * item.qtde, 0);
      }

      function obterCategoriaProduto(nome) {
        for (const cat in estoqueDados) {
          if (estoqueDados[cat].some((p) => p.nome === nome)) return cat;
        }
        return "outros";
      }

      function atualizarEstoqueVisual() {
        const categorias = ["todos", "marmitas", "bebidas", "porcoes"];
        categorias.forEach((categoria) => {
          const lista = document.getElementById("estoqueLista");
          if (!lista) return;
          if (categoria === "todos") return;
          if (document.getElementById(`btnCat${categoria.charAt(0).toUpperCase() + categoria.slice(1)}Estoque`).classList.contains("active-category")) {
            renderizarEstoque(categoria);
          }
        });
      }

      function atualizarPainelFinanceiro() {
        const totalVendas = vendasFinalizadas.length;
        const mesasAtendidasSet = new Set(vendasFinalizadas.map((v) => v.mesa));
        const mesasAtendidas = mesasAtendidasSet.size;
        const valorTotal = vendasFinalizadas.reduce((acc, v) => acc + v.total, 0);

        document.getElementById("totalVendasCount").textContent = totalVendas;
        document.getElementById("mesasAtendidasCount").textContent = mesasAtendidas;
        document.getElementById("valorTotalVendas").textContent = `R$ ${valorTotal.toFixed(2).replace(".", ",")}`;

        const vendasPorMesa = {};
        vendasFinalizadas.forEach((v) => {
          vendasPorMesa[v.mesa] = (vendasPorMesa[v.mesa] || 0) + v.total;
        });
        const mesasLabels = Object.keys(vendasPorMesa);
        const vendasValores = Object.values(vendasPorMesa);

        if (window.graficoVendasPorMesa) {
          window.graficoVendasPorMesa.data.labels = mesasLabels;
          window.graficoVendasPorMesa.data.datasets[0].data = vendasValores;
          window.graficoVendasPorMesa.update();
        } else {
          const ctxMesa = document.getElementById("graficoVendasPorMesa").getContext("2d");
          window.graficoVendasPorMesa = new Chart(ctxMesa, {
            type: "bar",
            data: {
              labels: mesasLabels,
              datasets: [
                {
                  label: "Valor vendido por mesa (R$)",
                  data: vendasValores,
                  backgroundColor: "#2563eb",
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true },
              },
            },
          });
        }

        const vendasPorCategoria = {};
        vendasFinalizadas.forEach((v) => {
          v.itens.forEach((item) => {
            const cat = obterCategoriaProduto(item.name);
            vendasPorCategoria[cat] = (vendasPorCategoria[cat] || 0) + item.price * item.qtde;
          });
        });
        const categoriasLabels = Object.keys(vendasPorCategoria);
        const categoriasValores = Object.values(vendasPorCategoria);
        const cores = ["#2563eb", "#f97316", "#10b981", "#ef4444", "#8b5cf6", "#f59e0b"];

        if (window.graficoVendasPorCategoria) {
          window.graficoVendasPorCategoria.data.labels = categoriasLabels;
          window.graficoVendasPorCategoria.data.datasets[0].data = categoriasValores;
          window.graficoVendasPorCategoria.update();
        } else {
          const ctxCat = document.getElementById("graficoVendasPorCategoria").getContext("2d");
          window.graficoVendasPorCategoria = new Chart(ctxCat, {
            type: "doughnut",
            data: {
              labels: categoriasLabels,
              datasets: [
                {
                  label: "Vendas por Categoria (R$)",
                  data: categoriasValores,
                  backgroundColor: cores.slice(0, categoriasLabels.length),
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: "bottom" },
              },
            },
          });
        }
      }

      function gerarMesas() {
        mesasGrid.innerHTML = "";
        for (let i = 1; i <= 20; i++) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "relative px-1.5 py-0.5 rounded border border-[#0f3a7d] hover:bg-[#0f3a7d] hover:text-white transition font-semibold text-[#0f3a7d] flex items-center justify-between text-xs";
          btn.dataset.mesa = i;
          btn.textContent = "Mesa " + i;

          if (comandasEmAberto["Mesa " + i]) {
            const timerSpan = document.createElement("span");
            timerSpan.className = "timer ml-1";
            timerSpan.textContent = "00:00:00";
            btn.appendChild(timerSpan);
            iniciarCronometro("Mesa " + i, timerSpan);
          }

          btn.addEventListener("click", () => {
            selecionarMesa("Mesa " + i);
            fecharModal();
          });
          mesasGrid.appendChild(btn);
        }
      }

      function iniciarCronometro(mesa, element) {
        if (timers[mesa]) return;

        if (!comandasEmAberto[mesa].timestamp) {
          comandasEmAberto[mesa].timestamp = Date.now();
        }

        function atualizar() {
          const agora = Date.now();
          const diff = agora - comandasEmAberto[mesa].timestamp;
          const segundos = Math.floor(diff / 1000) % 60;
          const minutos = Math.floor(diff / (1000 * 60)) % 60;
          const horas = Math.floor(diff / (1000 * 60 * 60));
          element.textContent =
            String(horas).padStart(2, "0") +
            ":" +
            String(minutos).padStart(2, "0") +
            ":" +
            String(segundos).padStart(2, "0");
        }
        atualizar();
        timers[mesa] = setInterval(atualizar, 1000);
      }

      function pararCronometro(mesa) {
        if (timers[mesa]) {
          clearInterval(timers[mesa]);
          delete timers[mesa];
        }
      }

      function atualizarBadgeMesa() {
        if (mesaSelecionada && comandasEmAberto[mesaSelecionada]) {
          mesaStatusBadge.classList.remove("hidden");
          btnAbrirComandaMesa.disabled = false;
        } else {
          mesaStatusBadge.classList.add("hidden");
          btnAbrirComandaMesa.disabled = true;
        }
        atualizarContadorMesasAbertas();
      }

      function atualizarContadorMesasAbertas() {
        const count = Object.keys(comandasEmAberto).length;
        if (count > 0) {
          contadorMesasAbertas.textContent = count;
          contadorMesasAbertas.classList.remove("hidden");
        } else {
          contadorMesasAbertas.classList.add("hidden");
        }
      }

      function atualizarBadgeDelivery() {
        const count = pedidosDelivery.length;
        if (count > 0) {
          badgeDelivery.textContent = count;
          badgeDelivery.classList.remove("hidden");
          contadorDelivery.textContent = count;
          contadorDelivery.classList.remove("hidden");
        } else {
          badgeDelivery.classList.add("hidden");
          contadorDelivery.classList.add("hidden");
        }
      }

      function renderizarEstoque(categoria) {
        estoqueLista.innerHTML = "";
        let itens = [];
        if (categoria === "todos") {
          itens = estoqueDados.todos;
        } else {
          itens = estoqueDados[categoria];
        }
        itens.forEach((item) => {
          const div = document.createElement("div");
          div.className = "flex items-center justify-between border border-gray-300 rounded p-1.5";
          if (item.isTaxaEntrega) {
            div.innerHTML = `
              <div class="flex items-center space-x-1.5">
                <img src="${item.img}" alt="Imagem do produto ${item.nome}, embalagem padrão" class="w-8 h-8 rounded object-cover" />
                <div>
                  <div class="font-semibold text-[#0f3a7d] text-xs">${item.nome}</div>
                  <div class="text-xs text-gray-600">Preço: R$ <input type="number" min="0" step="0.01" id="inputTaxaEntrega" class="w-14 bg-gray-100 rounded px-1 py-0.5 text-xs text-gray-800" value="${item.preco.toFixed(2).replace('.', ',')}" /></div>
                </div>
              </div>
            `;
          } else {
            div.innerHTML = `
              <div class="flex items-center space-x-1.5">
                <img src="${item.img}" alt="Imagem do produto ${item.nome}, embalagem padrão" class="w-8 h-8 rounded object-cover" />
                <div>
                  <div class="font-semibold text-[#0f3a7d] text-xs">${item.nome}</div>
                  <div class="text-xs text-gray-600">Preço: R$ ${item.preco.toFixed(2).replace('.', ',')}</div>
                </div>
              </div>
              <div class="flex items-center space-x-1">
                <button class="px-2 py-0.5 bg-red-600 text-white rounded hover:bg-red-700 transition text-xs" data-id="${item.id}" data-categoria="${categoria}" data-action="decrementar">-</button>
                <span class="w-6 text-center font-semibold text-[#0f3a7d] text-xs" id="estoque-qty-${categoria}-${item.id}">${item.estoque}</span>
                <button class="px-2 py-0.5 bg-green-600 text-white rounded hover:bg-green-700 transition text-xs" data-id="${item.id}" data-categoria="${categoria}" data-action="incrementar">+</button>
              </div>
            `;
          }
          estoqueLista.appendChild(div);
        });

        estoqueLista.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = parseInt(btn.dataset.id);
            const categoriaBtn = btn.dataset.categoria;
            const action = btn.dataset.action;
            let item;
            if (categoriaBtn === "todos") {
              item =
                estoqueDados.marmitas.find((i) => i.id === id) ||
                estoqueDados.bebidas.find((i) => i.id === id) ||
                estoqueDados.porcoes.find((i) => i.id === id);
            } else {
              item = estoqueDados[categoriaBtn].find((i) => i.id === id);
            }
            if (!item) return;
            if (action === "incrementar") {
              item.estoque++;
            } else if (action === "decrementar" && item.estoque > 0) {
              item.estoque--;
            }
            const spanId = `estoque-qty-${categoriaBtn}-${id}`;
            const span = document.getElementById(spanId);
            if (span) {
              span.textContent = item.estoque;
            }
            if (categoriaBtn !== "todos") {
              const spanTodos = document.getElementById(`estoque-qty-todos-${id}`);
              if (spanTodos) {
                spanTodos.textContent = item.estoque;
              }
            }
          });
        });

        const inputTaxaEntrega = document.getElementById("inputTaxaEntrega");
        if (inputTaxaEntrega) {
          inputTaxaEntrega.addEventListener("input", (e) => {
            let val = e.target.value.replace(",", ".");
            let num = parseFloat(val);
            if (isNaN(num) || num < 0) num = 0;
            taxaEntregaValor = num;
            const taxaItem = estoqueDados.todos.find((i) => i.isTaxaEntrega);
            if (taxaItem) {
              taxaItem.preco = taxaEntregaValor;
            }
            if (mesaSelecionada && comanda[mesaSelecionada]) {
              let changed = false;
              comanda[mesaSelecionada].forEach((item) => {
                if (item.name === "Taxa de Entrega") {
                  item.price = taxaEntregaValor;
                  changed = true;
                }
              });
              if (changed) {
                atualizarComanda();
              }
            }
          });
        }
      }

      function renderizarProdutos(categoria) {
        produtosGrid.innerHTML = "";
        let itens = [];
        if (categoria === "marmitas") {
          itens = estoqueDados.marmitas;
        } else if (categoria === "bebidas") {
          itens = estoqueDados.bebidas;
        } else if (categoria === "porcoes") {
          itens = estoqueDados.porcoes;
        } else if (categoria === "todos") {
          itens = estoqueDados.todos;
        }
        if (categoria === "todos" && itens.length > 20) {
          itens = itens.slice(0, 20);
        }
        itens.forEach((item) => {
          const div = document.createElement("div");
          div.className =
            "cursor-pointer rounded border border-[#0a2a5a] bg-white p-1.5 flex flex-col items-center justify-center hover:bg-[#e0e7ff] transition select-none";
          div.dataset.name = item.nome;
          div.dataset.price = item.preco;
          div.dataset.img = item.img;
          div.setAttribute("tabindex", "0");
          div.setAttribute("role", "button");
          div.setAttribute(
            "aria-label",
            `Adicionar produto ${item.nome} ao pedido por R$ ${item.preco.toFixed(2).replace(".", ",")}`
          );
          div.innerHTML = `
            <img src="${item.img}" alt="Imagem do produto ${item.nome}, embalagem padrão" class="w-12 h-12 object-cover mb-1 rounded" />
            <span class="text-[9px] font-semibold text-[#0f3a7d] text-center">${item.nome}</span>
            <span class="text-[9px] text-gray-700">R$ ${item.preco.toFixed(2).replace(".", ",")}</span>
          `;
          div.addEventListener("click", () => {
            adicionarProduto({ name: item.nome, price: item.preco, img: item.img }, 1);
          });
          div.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              adicionarProduto({ name: item.nome, price: item.preco, img: item.img }, 1);
            }
          });
          produtosGrid.appendChild(div);
        });
        if (categoria === "todos") {
          produtosGrid.classList.add("scrollable");
        } else {
          produtosGrid.classList.remove("scrollable");
        }
      }

      function abrirModal() {
        modalMesas.classList.remove("hidden");
        gerarMesas();
      }
      function fecharModal() {
        modalMesas.classList.add("hidden");
      }

      function selecionarMesa(nome) {
        mesaSelecionada = nome;
        codigoInput.value = nome;
        if (!comanda[mesaSelecionada]) {
          comanda[mesaSelecionada] = [];
        }
        if (comandasEmAberto[mesaSelecionada]) {
          comanda[mesaSelecionada] = JSON.parse(JSON.stringify(comandasEmAberto[mesaSelecionada]));
          if (clientesComanda[mesaSelecionada]) {
            clienteNomeComandaInput.value = clientesComanda[mesaSelecionada];
          } else {
            clienteNomeComandaInput.value = "";
          }
        } else {
          clienteNomeComandaInput.value = "";
        }
        atualizarComanda();
        habilitarControles(true);
        atualizarBadgeMesa();
      }

      function habilitarControles(ativo) {
        btnCancelar.disabled = !ativo;
        btnFinalizar.disabled = !ativo;
      }

      function atualizarComanda() {
        if (!mesaSelecionada || !comanda[mesaSelecionada]) {
          comandaBody.innerHTML =
            '<tr><td colspan="6" class="text-center text-gray-400 py-2 select-text">Nenhuma mesa selecionada.</td></tr>';
          valorTotalEl.textContent = "R$ 0,00";
          habilitarControles(false);
          return;
        }
        const itens = comanda[mesaSelecionada];
        if (itens.length === 0) {
          comandaBody.innerHTML =
            '<tr><td colspan="6" class="text-center text-gray-400 py-2 select-text">Nenhum item adicionado.</td></tr>';
          valorTotalEl.textContent = "R$ 0,00";
          habilitarControles(true);
          return;
        }
        let total = 0;
        comandaBody.innerHTML = "";
        itens.forEach((item, index) => {
          const totalItem = item.price * item.qtde;
          total += totalItem;

          const tr = document.createElement("tr");
          tr.className = "border-b border-[#f97316]";
          tr.innerHTML = `
            <td class="px-2 py-1">
              <img src="${item.img || 'https://placehold.co/40x40/png?text=Sem+Imagem'}" alt="Imagem do produto ${item.name}, embalagem padrão" class="w-8 h-8 rounded object-cover" />
            </td>
            <td class="text-left px-2 py-1 text-xs">${item.name}</td>
            <td class="text-center text-xs">${item.qtde}</td>
            <td class="text-right pr-2 text-xs">R$ ${item.price.toFixed(2).replace('.', ',')}</td>
            <td class="text-right pr-2 text-xs">R$ ${totalItem.toFixed(2).replace('.', ',')}</td>
            <td class="text-center pr-2">
              <button class="remove-item" aria-label="Remover item" data-index="${index}" title="Remover item">
                <i class="fas fa-trash-alt text-xs"></i>
              </button>
            </td>
          `;
          comandaBody.appendChild(tr);
        });
        valorTotalEl.textContent = `R$ ${total.toFixed(2).replace(".", ",")}`;

        comandaBody.querySelectorAll("button.remove-item").forEach((btn) => {
          btn.addEventListener("click", () => {
            const idx = parseInt(btn.dataset.index);
            if (isNaN(idx)) return;
            const itemRemovido = comanda[mesaSelecionada][idx];
            if (itemRemovido && !itemRemovido.isTaxaEntrega) {
              for (const cat in estoqueDados) {
                const prod = estoqueDados[cat].find((p) => p.nome === itemRemovido.name);
                if (prod) {
                  prod.estoque += itemRemovido.qtde;
                  break;
                }
              }
            }
            comanda[mesaSelecionada].splice(idx, 1);
            atualizarComanda();
            atualizarEstoqueVisual();
            btnVenda.click();
          });
        });
      }

      function adicionarProduto(produto, quantidade) {
        if (!mesaSelecionada) {
          alert("Selecione uma mesa antes de adicionar itens.");
          return;
        }
        if (!produto.isTaxaEntrega) {
          for (const cat in estoqueDados) {
            const prod = estoqueDados[cat].find((p) => p.nome === produto.name);
            if (prod) {
              if (prod.estoque < quantidade) {
                alert(`Estoque insuficiente para o produto ${produto.name}.`);
                return;
              }
              break;
            }
          }
        }
        const itens = comanda[mesaSelecionada];
        const index = itens.findIndex((i) => i.name === produto.name);
        if (index >= 0) {
          if (!produto.isTaxaEntrega) {
            for (const cat in estoqueDados) {
              const prod = estoqueDados[cat].find((p) => p.nome === produto.name);
              if (prod) {
                if (prod.estoque < quantidade) {
                  alert(`Estoque insuficiente para o produto ${produto.name}.`);
                  return;
                }
                break;
              }
            }
          }
          itens[index].qtde += quantidade;
          if (itens[index].qtde < 1) itens[index].qtde = 1;
        } else {
          itens.push({ ...produto, qtde: quantidade });
        }
        if (!produto.isTaxaEntrega) {
          for (const cat in estoqueDados) {
            const prod = estoqueDados[cat].find((p) => p.nome === produto.name);
            if (prod) {
              prod.estoque -= quantidade;
              break;
            }
          }
        }
        atualizarComanda();
        atualizarEstoqueVisual();
      }

      function imprimirComanda() {
        if (!mesaSelecionada || !comanda[mesaSelecionada] || comanda[mesaSelecionada].length === 0) {
          alert("Nenhuma comanda para imprimir.");
          return;
        }
        const itens = comanda[mesaSelecionada];
        let texto = `Comanda - ${mesaSelecionada}\n`;
        const clienteNome = clienteNomeComandaInput.value.trim();
        if (clienteNome) {
          texto += `Cliente: ${clienteNome}\n`;
        }
        texto += `\n`;
        let total = 0;
        itens.forEach((item) => {
          const totalItem = item.price * item.qtde;
          total += totalItem;
          texto += `${item.name} - Qtde: ${item.qtde} x R$ ${item.price.toFixed(2).replace(".", ",")} = R$ ${totalItem.toFixed(2).replace(".", ",")}\n`;
        });
        texto += `\nTotal: R$ ${total.toFixed(2).replace(".", ",")}`;

        if (navigator.share && window.innerWidth <= 767) {
          navigator.share({
            title: `Comanda - ${mesaSelecionada}`,
            text: texto,
          }).catch((error) => {
            alert("Erro ao compartilhar: " + error);
          });
        } else {
          const printWindow = window.open("", "", "width=400,height=600");
          printWindow.document.write('<pre style="font-family:sans-serif; font-size:16px;">' + texto + "</pre>");
          printWindow.document.close();
          printWindow.focus();
          printWindow.print();
        }
      }

      function armazenarComandaCard(mesa, itens) {
        if (!itens || itens.length === 0) return;
        const card = document.createElement("div");
        card.className = "border border-[#0f3a7d] rounded p-2 shadow-md relative";

        let itensHtml = "";
        let total = 0;
        itens.forEach((item) => {
          const totalItem = item.price * item.qtde;
          total += totalItem;
          itensHtml += `
            <div class="flex items-center space-x-2 mb-1">
              <img src="${item.img || 'https://placehold.co/40x40/png?text=Sem+Imagem'}" alt="Imagem do produto ${item.name}, embalagem padrão" class="w-8 h-8 rounded object-cover" />
              <div class="flex-1">
                <div class="font-semibold text-[#0f3a7d] text-xs">${item.name}</div>
                <div class="text-[9px] text-gray-600">Qtd: ${item.qtde} x R$ ${item.price.toFixed(2).replace(".", ",")}</div>
              </div>
              <div class="font-semibold text-[#0f3a7d] text-xs">R$ ${totalItem.toFixed(2).replace(".", ",")}</div>
            </div>
          `;
        });

        const clienteNome = clientesComanda[mesa] || "";

        card.innerHTML = `
          <h3 class="text-sm font-bold text-[#0f3a7d] mb-1 select-text">Comanda - ${mesa}</h3>
          <input type="text" class="editable-cliente mb-1" value="${clienteNome}" placeholder="Nome do cliente" aria-label="Nome do cliente da comanda" />
          ${itensHtml}
          <div class="text-right font-bold text-[#0f3a7d] border-t border-gray-300 pt-1 mb-2 text-xs">Total: R$ ${total.toFixed(2).replace(".", ",")}</div>
          <div class="flex space-x-1 justify-end" style="">
            <button type="button" class="btn-em-aberto bg-[#2563eb] hover:bg-[#1e40af] text-white text-xs font-semibold px-2 py-0.5 rounded shadow transition" aria-label="Em aberto comanda">
              Em Aberto
            </button>
            <button type="button" id="btnImprimirComandaCard" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold px-2 py-0.5 rounded shadow transition" aria-label="Imprimir comanda">
              Imprimir
            </button>
            <button type="button" class="btn-encerrar bg-green-700 hover:bg-green-800 text-white text-xs font-semibold px-2 py-0.5 rounded shadow transition" aria-label="Encerrar comanda">
              Encerrar
            </button>
          </div>
        `;

        const inputClienteCard = card.querySelector(".editable-cliente");
        inputClienteCard.addEventListener("input", () => {
          clientesComanda[mesa] = inputClienteCard.value.trim();
          if (mesaSelecionada === mesa) {
            clienteNomeComandaInput.value = clientesComanda[mesa];
          }
        });

        const btnEmAberto = card.querySelector(".btn-em-aberto");
        const btnEncerrar = card.querySelector(".btn-encerrar");
        const btnImprimirCard = card.querySelector("#btnImprimirComandaCard");

        btnEmAberto.addEventListener("click", () => {
          comandasEmAberto[mesa] = JSON.parse(JSON.stringify(itens));
          comandasEmAberto[mesa].timestamp = Date.now();
          clientesComanda[mesa] = inputClienteCard.value.trim();
          btnAbrirComandaMesa.disabled = false;
          fecharModal();
          const index = comandasFinalizadas.indexOf(card);
          if (index > -1) {
            comandasFinalizadas.splice(index, 1);
          }
          mostrarComandas();
          atualizarBadgeMesa();
          atualizarBadgePedidos();
          btnFinalizar.click();
        });

        btnEncerrar.addEventListener("click", () => {
          adicionarPedidoAberto({
            mesa,
            itens: JSON.parse(JSON.stringify(itens)),
            total,
            entregue: false,
            clienteNome: clientesComanda[mesa] || "",
          });
          vendasFinalizadas.push({
            mesa,
            itens: JSON.parse(JSON.stringify(itens)),
            total,
          });
          salvarVendasLocalStorage();
          delete comandasEmAberto[mesa];
          delete clientesComanda[mesa];
          pararCronometro(mesa);
          const index = comandasFinalizadas.indexOf(card);
          if (index > -1) {
            comandasFinalizadas.splice(index, 1);
          }
          mostrarComandas();
          atualizarBadgeMesa();
          atualizarPainelFinanceiro();
          atualizarBadgePedidos();
          alert(`Comanda da ${mesa} encerrada e enviada para o financeiro.`);
          selecionarProximaMesaDisponivel();
        });

        btnImprimirCard.addEventListener("click", () => {
          if (!mesa || !itens || itens.length === 0) {
            alert("Nenhuma comanda para imprimir.");
            return;
          }
          let texto = `Comanda - ${mesa}\n`;
          const clienteNomePrint = inputClienteCard.value.trim();
          if (clienteNomePrint) {
            texto += `Cliente: ${clienteNomePrint}\n`;
          }
          texto += `\n`;
          let totalPrint = 0;
          itens.forEach((item) => {
            const totalItem = item.price * item.qtde;
            totalPrint += totalItem;
            texto += `${item.name} - Qtde: ${item.qtde} x R$ ${item.price.toFixed(2).replace(".", ",")} = R$ ${totalItem.toFixed(2).replace(".", ",")}\n`;
          });
          texto += `\nTotal: R$ ${totalPrint.toFixed(2).replace(".", ",")}`;

          if (navigator.share && window.innerWidth <= 767) {
            navigator.share({
              title: `Comanda - ${mesa}`,
              text: texto,
            }).catch((error) => {
              alert("Erro ao compartilhar: " + error);
            });
          } else {
            const printWindow = window.open("", "", "width=400,height=600");
            printWindow.document.write('<pre style="font-family:sans-serif; font-size:16px;">' + texto + "</pre>");
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
          }
        });

        comandasFinalizadas.push(card);
      }

      function mostrarComandas() {
        comandaCardsContainer.innerHTML = "";
        if (comandasFinalizadas.length === 0) {
          comandaCardsContainer.innerHTML =
            '<p class="text-gray-500 select-text">Nenhuma comanda em aberto.</p>';
          comandaCardsContainer.classList.add("hidden");
          vendaSection.classList.remove("hidden");
          estoqueSection.classList.add("hidden");
          financeiroSection.classList.add("hidden");
          deliverySection.classList.add("hidden");
          return;
        }
        comandasFinalizadas.forEach((card) => {
          comandaCardsContainer.appendChild(card);
        });
        comandaCardsContainer.classList.remove("hidden");
        vendaSection.classList.add("hidden");
        estoqueSection.classList.add("hidden");
        financeiroSection.classList.add("hidden");
        deliverySection.classList.add("hidden");
      }

      function atualizarBotaoAtivo(container, clickedBtn) {
        container.querySelectorAll("button").forEach((btn) => {
          btn.classList.remove("active-category");
          if (btn === clickedBtn) {
            btn.classList.add("active-category");
          }
        });
      }

      function adicionarPedidoAberto(pedido) {
        if (pedido.clienteNome) {
          pedido.clienteNome = pedido.clienteNome;
        }
        pedidosAbertos.push(pedido);
        atualizarBadgePedidos();
      }

      function atualizarBadgePedidos() {
        if (pedidosAbertos.length > 0) {
          badgePedidos.textContent = pedidosAbertos.length;
          badgePedidos.classList.remove("hidden");
        } else {
          badgePedidos.classList.add("hidden");
        }
      }

      function mostrarPedidos() {
        comandaCardsContainer.innerHTML = "";
        if (pedidosAbertos.length === 0) {
          comandaCardsContainer.innerHTML =
            '<p class="text-gray-500 select-text">Nenhum pedido aberto.</p>';
          comandaCardsContainer.classList.remove("hidden");
          vendaSection.classList.add("hidden");
          estoqueSection.classList.add("hidden");
          financeiroSection.classList.add("hidden");
          deliverySection.classList.add("hidden");
          return;
        }
        pedidosAbertos.forEach((pedido, idx) => {
          const card = document.createElement("div");
          card.className = "border border-[#0f3a7d] rounded p-2 shadow-md relative";

          let itensHtml = "";
          pedido.itens.forEach((item) => {
            const totalItem = item.price * item.qtde;
            itensHtml += `
              <div class="flex items-center space-x-2 mb-1">
                <img src="${item.img || 'https://placehold.co/40x40/png?text=Sem+Imagem'}" alt="Imagem do produto ${item.name}, embalagem padrão" class="w-8 h-8 rounded object-cover" />
                <div class="flex-1">
                  <div class="font-semibold text-[#0f3a7d] text-xs">${item.name}</div>
                  <div class="text-[9px] text-gray-600">Qtd: ${item.qtde} x R$ ${item.price.toFixed(2).replace(".", ",")}</div>
                </div>
                <div class="font-semibold text-[#0f3a7d] text-xs">R$ ${totalItem.toFixed(2).replace(".", ",")}</div>
              </div>
            `;
          });

          const entregue = pedido.entregue === true;

          const clienteNomeDisplay = pedido.clienteNome ? `<div><strong>Cliente:</strong> ${pedido.clienteNome}</div>` : "";

          card.innerHTML = `
            <h3 class="text-sm font-bold text-[#0f3a7d] mb-1 select-text">Pedidos - <input type="text" class="editable-mesa" value="${pedido.mesa}" aria-label="Editar nome da mesa"></h3>
            ${itensHtml}
            ${clienteNomeDisplay}
            <div class="text-right font-bold text-[#0f3a7d] border-t border-gray-300 pt-1 mb-2 text-xs">Total: R$ ${pedido.total.toFixed(2).replace(".", ",")}</div>
            <div class="flex space-x-1 justify-end" style="">
              ${
                !entregue
                  ? '<button type="button" class="btn-entregar bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-semibold px-2 py-0.5 rounded shadow transition" aria-label="Entregar pedido">Entregar</button>'
                  : ""
              }
              <button type="button" class="btn-remover-pedido bg-red-600 hover:bg-red-700 text-white text-xs font-semibold px-2 py-0.5 rounded shadow transition" aria-label="Remover pedido">
                Remover
              </button>
            </div>
          `;

          const inputMesa = card.querySelector(".editable-mesa");
          inputMesa.addEventListener("change", () => {
            const novoNome = inputMesa.value.trim();
            if (novoNome) {
              pedido.mesa = novoNome;
            } else {
              inputMesa.value = pedido.mesa;
            }
          });

          const btnRemover = card.querySelector(".btn-remover-pedido");
          btnRemover.addEventListener("click", () => {
            pedidosAbertos.splice(idx, 1);
            atualizarBadgePedidos();
            mostrarPedidos();
            btnVenda.click();
          });

          const btnEntregar = card.querySelector(".btn-entregar");
          if (btnEntregar) {
            btnEntregar.addEventListener("click", () => {
              pedido.entregue = true;
              pedidosDelivery.push({
                mesa: pedido.mesa,
                itens: JSON.parse(JSON.stringify(pedido.itens)),
                total: pedido.total,
                clienteNome: pedido.clienteNome || "",
                enderecoColeta: "Rua Báltico 79 Jardim Presidente",
                enderecoEntrega: "",
                status: "pendente",
              });
              pedidosAbertos.splice(idx, 1);
              atualizarBadgePedidos();
              mostrarPedidos();
              btnDelivery.click();
            });
          }

          comandaCardsContainer.appendChild(card);
        });
        comandaCardsContainer.classList.remove("hidden");
        vendaSection.classList.add("hidden");
        estoqueSection.classList.add("hidden");
        financeiroSection.classList.add("hidden");
        deliverySection.classList.add("hidden");
      }

      function mostrarDelivery() {
        deliveryPedidosContainer.innerHTML = "";
        if (pedidosDelivery.length === 0) {
          deliveryPedidosContainer.innerHTML =
            '<p class="text-gray-500 select-text">Nenhuma entrega.</p>';
          deliverySection.classList.remove("hidden");
          vendaSection.classList.add("hidden");
          estoqueSection.classList.add("hidden");
          financeiroSection.classList.add("hidden");
          comandaCardsContainer.classList.add("hidden");
          atualizarBadgeDelivery();
          return;
        }
        pedidosDelivery.forEach((pedido, idx) => {
          const card = document.createElement("div");
          card.className = "border border-[#0f3a7d] rounded p-2 shadow-md relative";

          let itensHtml = "";
          pedido.itens.forEach((item) => {
            const totalItem = item.price * item.qtde;
            itensHtml += `
              <div class="flex items-center space-x-2 mb-1">
                <img src="${item.img || 'https://placehold.co/40x40/png?text=Sem+Imagem'}" alt="Imagem do produto ${item.name}, embalagem padrão" class="w-8 h-8 rounded object-cover" />
                <div class="flex-1">
                  <div class="font-semibold text-[#0f3a7d] text-xs">${item.name}</div>
                  <div class="text-[9px] text-gray-600">Qtd: ${item.qtde} x R$ ${item.price.toFixed(2).replace(".", ",")}</div>
                </div>
                <div class="font-semibold text-[#0f3a7d] text-xs">R$ ${totalItem.toFixed(2).replace(".", ",")}</div>
              </div>
            `;
          });

          const status = pedido.status || "pendente";

          const temInfoEntrega = pedido.clienteNome && pedido.enderecoColeta && pedido.enderecoEntrega;

          let printButtonHtml = "";
          if (temInfoEntrega) {
            printButtonHtml = `<button type="button" class="btn-imprimir-delivery bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold px-2 py-0.5 rounded shadow transition" aria-label="Imprimir entrega">Imprimir</button>`;
          }

          card.innerHTML = `
            <h3 class="text-sm font-bold text-[#0f3a7d] mb-1 select-text">Entregas - ${pedido.mesa}</h3>
            ${itensHtml}
            <div class="mb-1 text-[9px]">
              <strong>Cliente:</strong> ${pedido.clienteNome || '<em>Não informado</em>'}<br/>
              <strong>Endereço Coleta:</strong> ${pedido.enderecoColeta || '<em>Não informado</em>'}<br/>
              <strong>Endereço Entrega:</strong> ${pedido.enderecoEntrega || '<em>Não informado</em>'}
            </div>
            <div class="text-right font-bold text-[#0f3a7d] border-t border-gray-300 pt-1 mb-2 text-xs">Total: R$ ${pedido.total.toFixed(2).replace(".", ",")}</div>
            <div class="flex space-x-2 justify-between items-center">
              <div id="rateInfo-${idx}" class="text-xs text-gray-700">Consultando taxas de entrega...</div>
              <div class="flex space-x-1">
                ${status === "pendente" ? `<button type="button" class="btn-editar-delivery bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-semibold px-2 py-0.5 rounded shadow transition" aria-label="Editar entrega">Editar</button>` : ''}
                <button type="button" class="btn-remover-delivery bg-red-600 hover:bg-red-700 text-white text-xs font-semibold px-2 py-0.5 rounded shadow transition" aria-label="Remover entrega">Remover</button>
                ${printButtonHtml}
              </div>
            </div>
          `;

          const btnRemover = card.querySelector(".btn-remover-delivery");
          btnRemover.addEventListener("click", () => {
            pedidosDelivery.splice(idx, 1);
            mostrarDelivery();
          });

          const btnEditar = card.querySelector(".btn-editar-delivery");
          if (btnEditar) {
            btnEditar.addEventListener("click", () => {
              abrirModalDelivery(pedido, idx);
            });
          }

          const btnImprimirDelivery = card.querySelector(".btn-imprimir-delivery");
          if (btnImprimirDelivery) {
            btnImprimirDelivery.addEventListener("click", () => {
              if (!pedido || !pedido.itens || pedido.itens.length === 0) {
                alert("Nenhuma entrega para imprimir.");
                return;
              }
              let texto = `Entrega - ${pedido.mesa}\n\nCliente: ${pedido.clienteNome}\nEndereço Coleta: ${pedido.enderecoColeta}\nEndereço Entrega: ${pedido.enderecoEntrega}\n\nItens:\n`;
              let totalPrint = 0;
              pedido.itens.forEach((item) => {
                const totalItem = item.price * item.qtde;
                totalPrint += totalItem;
                texto += `${item.name} - Qtde: ${item.qtde} x R$ ${item.price.toFixed(2).replace(".", ",")} = R$ ${totalItem.toFixed(2).replace(".", ",")}\n`;
              });
              texto += `\nTotal: R$ ${totalPrint.toFixed(2).replace(".", ",")}`;

              if (navigator.share && window.innerWidth <= 767) {
                navigator.share({
                  title: `Entrega - ${pedido.mesa}`,
                  text: texto,
                }).catch((error) => {
                  alert("Erro ao compartilhar: " + error);
                });
              } else {
                const printWindow = window.open("", "", "width=400,height=600");
                printWindow.document.write('<pre style="font-family:sans-serif; font-size:16px;">' + texto + "</pre>");
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
              }
            });
          }

          deliveryPedidosContainer.appendChild(card);

          consultarTaxasEntrega(pedido, idx, false, true);
        });
        deliverySection.classList.remove("hidden");
        vendaSection.classList.add("hidden");
        estoqueSection.classList.add("hidden");
        financeiroSection.classList.add("hidden");
        comandaCardsContainer.classList.add("hidden");
        atualizarBadgeDelivery();
      }

      let currentDeliveryEditIndex = null;
      function abrirModalDelivery(pedido, idx) {
        currentDeliveryEditIndex = idx;
        formDelivery.clienteNome.value = pedido.clienteNome || "";
        formDelivery.enderecoColeta.value = pedido.enderecoColeta || "Rua Báltico 79 Jardim Presidente";
        formDelivery.enderecoEntrega.value = pedido.enderecoEntrega || "";
        deliveryRatesDiv.innerHTML = '<p>Consultando taxas de entrega...</p>';
        modalDelivery.classList.add("active");
        consultarTaxasEntrega(pedido, idx, true, false);
      }

      function fecharModalDelivery() {
        modalDelivery.classList.remove("active");
        currentDeliveryEditIndex = null;
      }

      function consultarTaxasEntrega(pedido, idx, isModal = false, atualizarPrecoTotal = false) {
        const rateInfoEl = isModal ? deliveryRatesDiv : document.getElementById(`rateInfo-${idx}`);
        const deliveryPriceTotalEl = atualizarPrecoTotal ? document.getElementById(`deliveryPriceTotal-${idx}`) : null;
        if (!rateInfoEl) return;
        rateInfoEl.textContent = "Consultando taxas de entrega...";

        setTimeout(() => {
          const coletaLen = pedido.enderecoColeta ? pedido.enderecoColeta.length : 0;
          const entregaLen = pedido.enderecoEntrega ? pedido.enderecoEntrega.length : 0;
          const distanciaSimulada = Math.abs(entregaLen - coletaLen) + 5;

          const uberRate = (distanciaSimulada * 1.5 + 3).toFixed(2);
          const noventaENoveRate = (distanciaSimulada * 1.3 + 2.5).toFixed(2);

          const html = `
            <div><strong>Uber:</strong> R$ ${uberRate.replace(".", ",")}</div>
            <div><strong>99:</strong> R$ ${noventaENoveRate.replace(".", ",")}</div>
          `;
          rateInfoEl.innerHTML = html;

          if (isModal && currentDeliveryEditIndex !== null) {
            pedidosDelivery[currentDeliveryEditIndex].uberRate = uberRate;
            pedidosDelivery[currentDeliveryEditIndex].noventaENoveRate = noventaENoveRate;
          }

          if (atualizarPrecoTotal && deliveryPriceTotalEl) {
            const precoItens = pedido.total || 0;
            const menorTaxa = Math.min(parseFloat(uberRate), parseFloat(noventaENoveRate));
            const precoTotalComEntrega = precoItens + menorTaxa;
            deliveryPriceTotalEl.textContent = `Preço Total com Entrega: R$ ${precoTotalComEntrega.toFixed(2).replace(".", ",")}`;
          }
        }, 1500);
      }

      btnCancelDelivery.addEventListener("click", () => {
        fecharModalDelivery();
      });

      formDelivery.addEventListener("submit", (e) => {
        e.preventDefault();
        if (currentDeliveryEditIndex === null) return;

        const clienteNome = formDelivery.clienteNome.value.trim();
        const enderecoColeta = formDelivery.enderecoColeta.value.trim();
        const enderecoEntrega = formDelivery.enderecoEntrega.value.trim();

        if (!clienteNome || !enderecoColeta || !enderecoEntrega) {
          alert("Por favor, preencha todos os campos.");
          return;
        }

        pedidosDelivery[currentDeliveryEditIndex].clienteNome = clienteNome;
        pedidosDelivery[currentDeliveryEditIndex].enderecoColeta = enderecoColeta;
        pedidosDelivery[currentDeliveryEditIndex].enderecoEntrega = enderecoEntrega;
        pedidosDelivery[currentDeliveryEditIndex].status = "confirmado";

        fecharModalDelivery();
        mostrarDelivery();
        alert("Informações de entrega atualizadas com sucesso.");
      });

      btnCreateOrder.addEventListener("click", () => {
        inputCreateOrder.value = "";
        modalCreateOrder.classList.add("active");
      });

      btnCancelCreateOrder.addEventListener("click", () => {
        modalCreateOrder.classList.remove("active");
      });

      btnConfirmCreateOrder.addEventListener("click", () => {
        const texto = inputCreateOrder.value.trim();
        if (!texto) {
          alert("Por favor, insira o texto do pedido.");
          return;
        }
        const enderecoRegex = /Endereço:\s*(.+)/i;
        const contatoRegex = /Contato:\s*(\d{8,15})/i;
        const observacoesRegex = /Observações:\s*(.+)/i;
        const formaPagamentoRegex = /Forma de pagamento:\s*(.+)/i;

        const enderecoMatch = texto.match(enderecoRegex);
        const contatoMatch = texto.match(contatoRegex);
        const observacoesMatch = texto.match(observacoesRegex);
        const formaPagamentoMatch = texto.match(formaPagamentoRegex);

        const linhas = texto.split("\n");
        const itens = [];
        const regexItem = /^\*(.+?)\*\s+x(\d+)\s+-\s+R\$ ?([\d.,]+)$/i;
        for (const linha of linhas) {
          const match = linha.trim().match(regexItem);
          if (match) {
            const nome = match[1].trim();
            const qtde = parseInt(match[2]);
            const precoStr = match[3].replace(",", ".");
            const preco = parseFloat(precoStr);
            if (isNaN(qtde) || isNaN(preco)) continue;
            let img = "https://placehold.co/40x40/png?text=Sem+Imagem";
            for (const cat in estoqueDados) {
              const prod = estoqueDados[cat].find((p) => p.nome.toLowerCase() === nome.toLowerCase());
              if (prod) {
                img = prod.img;
                break;
              }
            }
            itens.push({ name: nome, qtde, price: preco, img });
          }
        }
        if (itens.length === 0) {
          alert("Nenhum item válido encontrado no texto.");
          return;
        }

        if (enderecoMatch) {
          const enderecoEntrega = enderecoMatch[1].trim();
          const contato = contatoMatch ? contatoMatch[1].trim() : "";
          const clienteNome = observacoesMatch ? observacoesMatch[1].trim() : "";
          const formaPagamento = formaPagamentoMatch ? formaPagamentoMatch[1].trim() : "";

          const pedidoDelivery = {
            mesa: "Delivery",
            itens,
            total: calcularTotal(itens),
            clienteNome,
            enderecoColeta: "Rua Báltico 79 Jardim Presidente",
            enderecoEntrega,
            contato,
            formaPagamento,
            status: "pendente",
          };
          pedidosDelivery.push(pedidoDelivery);
          atualizarBadgeDelivery();
          mostrarDelivery();
          modalCreateOrder.classList.remove("active");
          alert("Pedido criado na aba Entregas com endereço e contato preenchidos.");
          return;
        }

        if (!mesaSelecionada) {
          alert("Selecione uma mesa antes de criar a comanda.");
          return;
        }
        comanda[mesaSelecionada] = itens;
        atualizarComanda();
        habilitarControles(true);
        modalCreateOrder.classList.remove("active");
        alert("Comanda criada a partir do texto com sucesso.");
      });

      const btnsFiltroVenda = document.querySelectorAll("#vendaSection > div > button");
      btnsFiltroVenda.forEach((btn) => {
        btn.addEventListener("click", () => {
          const categoria = btn.dataset.categoria;
          atualizarBotaoAtivo(btn.parentElement, btn);
          renderizarProdutos(categoria);
        });
      });

      const btnsFiltroEstoque = document.querySelectorAll("#estoqueSection > div > button");
      btnsFiltroEstoque.forEach((btn) => {
        btn.addEventListener("click", () => {
          const categoria = btn.dataset.categoria;
          atualizarBotaoAtivo(btn.parentElement, btn);
          renderizarEstoque(categoria);
        });
      });

      btnEstoque.addEventListener("click", () => {
        vendaSection.classList.add("hidden");
        estoqueSection.classList.remove("hidden");
        financeiroSection.classList.add("hidden");
        comandaCardsContainer.classList.add("hidden");
        deliverySection.classList.add("hidden");
        btnEstoque.classList.add("text-[#f97316]");
        btnVenda.classList.remove("text-[#f97316]");
        btnFinanceiro.classList.remove("text-[#f97316]");
        btnPedidos.classList.remove("text-[#f97316]");
        btnDelivery.classList.remove("text-[#f97316]");
      });

      btnVenda.addEventListener("click", () => {
        vendaSection.classList.remove("hidden");
        estoqueSection.classList.add("hidden");
        financeiroSection.classList.add("hidden");
        comandaCardsContainer.classList.add("hidden");
        deliverySection.classList.add("hidden");
        btnEstoque.classList.remove("text-[#f97316]");
        btnVenda.classList.add("text-[#f97316]");
        btnFinanceiro.classList.remove("text-[#f97316]");
        btnPedidos.classList.remove("text-[#f97316]");
        btnDelivery.classList.remove("text-[#f97316]");
      });

      btnFinanceiro.addEventListener("click", () => {
        vendaSection.classList.add("hidden");
        estoqueSection.classList.add("hidden");
        financeiroSection.classList.remove("hidden");
        comandaCardsContainer.classList.add("hidden");
        deliverySection.classList.add("hidden");
        btnEstoque.classList.remove("text-[#f97316]");
        btnVenda.classList.remove("text-[#f97316]");
        btnFinanceiro.classList.add("text-[#f97316]");
        btnPedidos.classList.remove("text-[#f97316]");
        btnDelivery.classList.remove("text-[#f97316]");
        atualizarPainelFinanceiro();
      });

      btnPedidos.addEventListener("click", () => {
        mostrarPedidos();
        btnEstoque.classList.remove("text-[#f97316]");
        btnVenda.classList.remove("text-[#f97316]");
        btnFinanceiro.classList.remove("text-[#f97316]");
        btnPedidos.classList.add("text-[#f97316]");
        btnDelivery.classList.remove("text-[#f97316]");
      });

      btnDelivery.addEventListener("click", () => {
        mostrarDelivery();
        btnEstoque.classList.remove("text-[#f97316]");
        btnVenda.classList.remove("text-[#f97316]");
        btnFinanceiro.classList.remove("text-[#f97316]");
        btnPedidos.classList.remove("text-[#f97316]");
        btnDelivery.classList.add("text-[#f97316]");
      });

      btnAbrirMesas.addEventListener("click", abrirModal);
      btnFecharMesas.addEventListener("click", fecharModal);

      btnCancelar.addEventListener("click", () => {
        if (!mesaSelecionada) return;
        comanda[mesaSelecionada].forEach((item) => {
          if (!item.isTaxaEntrega) {
            for (const cat in estoqueDados) {
              const prod = estoqueDados[cat].find((p) => p.nome === item.name);
              if (prod) {
                prod.estoque += item.qtde;
                break;
              }
            }
          }
        });
        comanda[mesaSelecionada] = [];
        clienteNomeComandaInput.value = "";
        atualizarComanda();
        atualizarEstoqueVisual();
        atualizarBadgeMesa();
      });

      function selecionarProximaMesaDisponivel() {
        for (let i = 1; i <= 20; i++) {
          const nomeMesa = "Mesa " + i;
          if (!comandasEmAberto[nomeMesa]) {
            selecionarMesa(nomeMesa);
            return;
          }
        }
      }

      function trocarMesaAposAcao() {
        selecionarProximaMesaDisponivel();
      }

      btnFinalizar.addEventListener("click", () => {
        if (!mesaSelecionada) return;
        armazenarComandaCard(mesaSelecionada, comanda[mesaSelecionada]);
        clientesComanda[mesaSelecionada] = clienteNomeComandaInput.value.trim();
        if (clientesComanda[mesaSelecionada]) {
          adicionarPedidoAberto({
            mesa: mesaSelecionada,
            itens: JSON.parse(JSON.stringify(comanda[mesaSelecionada])),
            total: calcularTotal(comanda[mesaSelecionada]),
            entregue: false,
            clienteNome: clientesComanda[mesaSelecionada],
          });
        }
        comanda[mesaSelecionada] = [];
        clienteNomeComandaInput.value = "";
        atualizarBadgeMesa();
        codigoInput.value = "";
        atualizarComanda();
        habilitarControles(false);
        trocarMesaAposAcao();
        mostrarComandas();
      });

      btnImprimirComanda.forEach((btn) => {
        btn.addEventListener("click", imprimirComanda);
      });

      btnAbrirComandaMesa.addEventListener("click", () => {
        if (!mesaSelecionada) {
          alert("Selecione uma mesa primeiro.");
          return;
        }
        const emAberto = comandasEmAberto[mesaSelecionada];
        if (!emAberto) {
          alert("Nenhuma comanda em aberto para esta mesa.");
          return;
        }
        comanda[mesaSelecionada] = JSON.parse(JSON.stringify(emAberto));
        if (clientesComanda[mesaSelecionada]) {
          clienteNomeComandaInput.value = clientesComanda[mesaSelecionada];
        } else {
          clienteNomeComandaInput.value = "";
        }
        atualizarComanda();
        habilitarControles(true);
        alert(`Comanda da ${mesaSelecionada} carregada.`);
      });

      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          if (appContainer.requestFullscreen) {
            appContainer.requestFullscreen();
          } else if (appContainer.webkitRequestFullscreen) {
            appContainer.webkitRequestFullscreen();
          } else if (appContainer.msRequestFullscreen) {
            appContainer.msRequestFullscreen();
          }
          btnFullscreenToggle.innerHTML = '<i class="fas fa-compress"></i><span>Sair Tela Cheia</span>';
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
          btnFullscreenToggle.innerHTML = '<i class="fas fa-expand"></i><span>Tela Cheia</span>';
        }
      }

      btnFullscreenToggle.addEventListener("click", toggleFullscreen);

      document.addEventListener("fullscreenchange", () => {
        if (!document.fullscreenElement) {
          btnFullscreenToggle.innerHTML = '<i class="fas fa-expand"></i><span>Tela Cheia</span>';
        }
      });

      document.addEventListener("keydown", (e) => {
        if (document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "TEXTAREA") return;
        const key = e.key.toLowerCase();
        switch (key) {
          case "t":
            adicionarProduto({ name: "Taxa de Entrega", price: taxaEntregaValor, img: "https://placehold.co/80x80/png?text=Entrega", isTaxaEntrega: true }, 1);
            break;
          case "p":
            adicionarProduto({ name: "Marmita P", price: 12.0, img: "https://placehold.co/80x80/png?text=Marmita+P" }, 1);
            break;
          case "m":
            adicionarProduto({ name: "Marmita M", price: 15.0, img: "https://placehold.co/80x80/png?text=Marmita+M" }, 1);
            break;
          case "g":
            adicionarProduto({ name: "Marmita G", price: 20.0, img: "https://placehold.co/80x80/png?text=Marmita+G" }, 1);
            break;
          case "1":
            adicionarProduto({ name: "Coca-Cola Mini 269ml", price: 5.0, img: "https://placehold.co/80x80/png?text=Coca-Cola+Mini" }, 1);
            break;
          case "2":
            adicionarProduto({ name: "Guaraná 310ml", price: 4.0, img: "https://placehold.co/80x80/png?text=Guaraná+310ml" }, 1);
            break;
          case "3":
            adicionarProduto({ name: "Refriko Pet 500ml", price: 5.0, img: "https://placehold.co/80x80/png?text=Refriko+500ml" }, 1);
            break;
          case "4":
            adicionarProduto({ name: "Coca-Cola Vidro 1L", price: 8.0, img: "https://placehold.co/80x80/png?text=Coca-Cola+1L" }, 1);
            break;
          case "5":
            adicionarProduto({ name: "Coca-Cola Pet 2L", price: 15.0, img: "https://placehold.co/80x80/png?text=Coca-Cola+2L" }, 1);
            break;
          case "6":
            adicionarProduto({ name: "Tubaína Pet 2L", price: 8.0, img: "https://placehold.co/80x80/png?text=Tubaína+2L" }, 1);
            break;
          case "7":
            adicionarProduto({ name: "Carne Assada 100g", price: 9.0, img: "https://placehold.co/80x80/png?text=Carne+Assada" }, 1);
            break;
          case "8":
            adicionarProduto({ name: "Marmita de Arroz", price: 7.0, img: "https://placehold.co/80x80/png?text=Marmita+Arroz" }, 1);
            break;
          case "9":
            adicionarProduto({ name: "Marmita de Feijão", price: 6.0, img: "https://placehold.co/80x80/png?text=Marmita+Feijão" }, 1);
            break;
          case "0":
            adicionarProduto({ name: "Marmita de Macarrão", price: 6.0, img: "https://placehold.co/80x80/png?text=Marmita+Macarrão" }, 1);
            break;
        }
      });

      clienteNomeComandaInput.addEventListener("input", () => {
        if (mesaSelecionada) {
          clientesComanda[mesaSelecionada] = clienteNomeComandaInput.value.trim();
        }
      });

      function init() {
        carregarVendasLocalStorage();
        gerarMesas();
        selecionarMesa("Mesa 1");
        habilitarControles(true);
        atualizarComanda();
        atualizarCategoriaTodos();
        renderizarEstoque("todos");
        renderizarProdutos("todos");
        atualizarBadgeMesa();
        atualizarPainelFinanceiro();
        atualizarBadgePedidos();
        atualizarContadorMesasAbertas();
        atualizarBadgeDelivery();
        document.body.addEventListener("click", (e) => {
          if (e.target.closest(".btn-entregar")) {
            const btnDelivery = document.getElementById("btnDelivery");
            if (btnDelivery) {
              btnDelivery.click();
            }
          }
        });
      }

      init();

      window.selecionarMesa = selecionarMesa;
      window.fecharModal = fecharModal;
    })();
  </script>
</body>
</html>
